import React, { useEffect, useRef } from "react";
import BpmnViewer from "bpmn-js/lib/Modeler";
import "bpmn-js/dist/assets/diagram-js.css";
import "bpmn-font/dist/css/bpmn-embedded.css";
import propertiesPanelModule from "bpmn-js-properties-panel";
import propertiesProviderModule from "bpmn-js-properties-panel/lib/provider/camunda";
import "bpmn-js-properties-panel/dist/assets/bpmn-js-properties-panel.css";
import camundaModdleDescriptor from "camunda-bpmn-moddle/resources/camunda";
import { useDiagramDefinitions } from "./contexts/DiagramDefinitions";

const BpmnView = () => {
	const containerRef = useRef(null);
	const viewerRef = useRef(null);
	const { setDiagramDefinitions } = useDiagramDefinitions();
	const handleElementChanged = (event) => {
		console.log("Elemento cambiado:", event.element);
		setDiagramDefinitions(viewerRef.current);
	};
	useEffect(() => {
		viewerRef.current = new BpmnViewer({
			container: containerRef.current,
			keyboard: {
				bindTo: window,
			},
			propertiesPanel: {
				parent: "#propview",
			},
			additionalModules: [propertiesPanelModule, propertiesProviderModule],
			moddleExtensions: {
				camunda: camundaModdleDescriptor,
			},
		});

		const importXML = (xml, Viewer) => {
			Viewer.importXML(xml, function (err) {
				if (err) {
					return console.error("could not import BPMN 2.0 diagram", err);
				}

				const canvas = Viewer.get("canvas");
				const overlays = Viewer.get("overlays");

				// Zoom to fit full viewport
				canvas.zoom("fit-viewport");

				// Attach an overlay to a node
				// overlays.add("SCAN_OK", "note", {
				// 	position: {
				// 		bottom: 0,
				// 		right: 0,
				// 	},
				// 	html: '<div class="diagram-note">Mixed up the labels?</div>',
				// });

				// canvas.addMarker("SCAN_OK", "needs-discussion");
			});
		};

		const diagramXML =
			'<?xml version="1.0" encoding="UTF-8"?><definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" targetNamespace="" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL http://www.omg.org/spec/BPMN/2.0/20100501/BPMN20.xsd"><collaboration id="sid-c0e745ff-361e-4afb-8c8d-2a1fc32b1424"><participant id="sid-87F4C1D6-25E1-4A45-9DA7-AD945993D06F" name="Usuario" processRef="sid-C3803939-0872-457F-8336-EAE484DC4A04" /><participant id="Participant_0zqjpjt" name="Servidor Frontend" processRef="Process_0etxkwm" /><participant id="Participant_0yhypw4" name="Servidor Backend con scraping" processRef="Process_1kez1i4" /><participant id="Participant_03wu5er" name="IBM - Voice to text" processRef="Process_1yybto5" /><messageFlow id="MessageFlow_0fcfikb" sourceRef="Task_0phvbjb" targetRef="Task_014yg06" /><messageFlow id="MessageFlow_0oxm7el" sourceRef="Task_014yg06" targetRef="Task_01emmgh" /><messageFlow id="MessageFlow_1ootxol" sourceRef="Task_01emmgh" targetRef="Task_113a2yn" /><messageFlow id="MessageFlow_1jzgtp7" sourceRef="Task_16la10t" targetRef="Task_1pe98do" /><messageFlow id="MessageFlow_0xayg9l" sourceRef="Task_0z65dbm" targetRef="Task_0usw65y" /><messageFlow id="MessageFlow_1ajh8uo" sourceRef="Task_0usw65y" targetRef="Task_1kxmblt" /><messageFlow id="MessageFlow_10hbb1y" sourceRef="Task_00o8ibt" targetRef="Task_0lllv5h" /><messageFlow id="MessageFlow_067dnx0" sourceRef="Task_0lllv5h" targetRef="Task_1w9eauz" /><messageFlow id="MessageFlow_0lql24z" sourceRef="Task_17ulza9" targetRef="Task_0y3ndud" /><messageFlow id="MessageFlow_1x3ivxo" sourceRef="Task_0y3ndud" targetRef="Task_1gxt8gw" /></collaboration><process id="sid-C3803939-0872-457F-8336-EAE484DC4A04" name="Customer" processType="None" isClosed="false" isExecutable="false"><extensionElements /><laneSet id="sid-b167d0d7-e761-4636-9200-76b7f0e8e83a"><lane id="sid-57E4FE0D-18E4-478D-BC5D-B15164E93254"><flowNodeRef>sid-D7F237E8-56D0-4283-A3CE-4F0EFE446138</flowNodeRef><flowNodeRef>Task_0qhb3aw</flowNodeRef><flowNodeRef>Task_0phvbjb</flowNodeRef><flowNodeRef>EndEvent_0kbyclf</flowNodeRef><flowNodeRef>Task_1gxt8gw</flowNodeRef><flowNodeRef>Task_00o8ibt</flowNodeRef><flowNodeRef>Task_1kxmblt</flowNodeRef></lane></laneSet><startEvent id="sid-D7F237E8-56D0-4283-A3CE-4F0EFE446138"><outgoing>SequenceFlow_0rp41cx</outgoing></startEvent><task id="Task_0qhb3aw" name="Ingresar a SmartBuyer"><incoming>SequenceFlow_0rp41cx</incoming><outgoing>SequenceFlow_1h4dcfb</outgoing></task><sequenceFlow id="SequenceFlow_0rp41cx" sourceRef="sid-D7F237E8-56D0-4283-A3CE-4F0EFE446138" targetRef="Task_0qhb3aw" /><task id="Task_0phvbjb" name="Ingresar búsqueda de los productos por voz"><incoming>SequenceFlow_1h4dcfb</incoming></task><sequenceFlow id="SequenceFlow_1h4dcfb" sourceRef="Task_0qhb3aw" targetRef="Task_0phvbjb" /><sequenceFlow id="SequenceFlow_1lkawm0" sourceRef="Task_1kxmblt" targetRef="Task_00o8ibt" /><sequenceFlow id="SequenceFlow_0nudiyd" sourceRef="Task_1gxt8gw" targetRef="EndEvent_0kbyclf" /><endEvent id="EndEvent_0kbyclf"><incoming>SequenceFlow_0nudiyd</incoming></endEvent><task id="Task_1gxt8gw" name="Visualizar el resultado del análisis de los precios en cada supermercado"><outgoing>SequenceFlow_0nudiyd</outgoing></task><task id="Task_00o8ibt" name="Confirmar lista de compras y enviarla para su análisis"><incoming>SequenceFlow_1lkawm0</incoming></task><task id="Task_1kxmblt" name="Recibir lista de compras organizada por productos"><outgoing>SequenceFlow_1lkawm0</outgoing></task></process><process id="Process_0etxkwm"><task id="Task_014yg06" name="Enviar información al servidor backend" /><task id="Task_0y3ndud" name="Recibir análisis realizado de los productos" /><task id="Task_0lllv5h" name="Enviar lista de compras" /><task id="Task_0usw65y" name="Recibir lista de compras y mostrar al usuario" /></process><process id="Process_1kez1i4"><task id="Task_01emmgh" name="Recibir solicitud" /><task id="Task_1pe98do" name="Recibir texto transcrito"><outgoing>SequenceFlow_13w2p5m</outgoing></task><task id="Task_0n7uv02" name="Formatear texto en una lista de compras"><incoming>SequenceFlow_13w2p5m</incoming><outgoing>SequenceFlow_14ierwp</outgoing></task><sequenceFlow id="SequenceFlow_13w2p5m" sourceRef="Task_1pe98do" targetRef="Task_0n7uv02" /><sequenceFlow id="SequenceFlow_14ierwp" sourceRef="Task_0n7uv02" targetRef="Task_0z65dbm" /><sequenceFlow id="SequenceFlow_0lgxer5" sourceRef="Task_1w9eauz" targetRef="Task_0is568d" /><sequenceFlow id="SequenceFlow_0owm2dt" sourceRef="Task_0is568d" targetRef="Task_17ulza9" /><task id="Task_0z65dbm" name="Retornar lista de compras al frontend"><incoming>SequenceFlow_14ierwp</incoming></task><task id="Task_1w9eauz" name="Recibir lista de compras"><outgoing>SequenceFlow_0lgxer5</outgoing></task><task id="Task_17ulza9" name="Organizar, comparar y analizar la información obtenida"><incoming>SequenceFlow_0owm2dt</incoming></task><task id="Task_0is568d" name="Usar Selenium para hacer web scraping de los precios de los productos en supermercados"><incoming>SequenceFlow_0lgxer5</incoming><outgoing>SequenceFlow_0owm2dt</outgoing></task></process><process id="Process_1yybto5"><task id="Task_113a2yn" name="Recibir audio de voz"><outgoing>SequenceFlow_0yb93ab</outgoing></task><sequenceFlow id="SequenceFlow_0yb93ab" sourceRef="Task_113a2yn" targetRef="Task_1w8lulf" /><sequenceFlow id="SequenceFlow_0um83tc" sourceRef="Task_1w8lulf" targetRef="Task_16la10t" /><task id="Task_1w8lulf" name="Realizar transcripción de voz a texto"><incoming>SequenceFlow_0yb93ab</incoming><outgoing>SequenceFlow_0um83tc</outgoing></task><task id="Task_16la10t" name="Enviar transcripción"><incoming>SequenceFlow_0um83tc</incoming></task></process><bpmndi:BPMNDiagram id="sid-74620812-92c4-44e5-949c-aa47393d3830"><bpmndi:BPMNPlane id="sid-cdcae759-2af7-4a6d-bd02-53f3352a731d" bpmnElement="sid-c0e745ff-361e-4afb-8c8d-2a1fc32b1424"><bpmndi:BPMNShape id="sid-87F4C1D6-25E1-4A45-9DA7-AD945993D06F_gui" bpmnElement="sid-87F4C1D6-25E1-4A45-9DA7-AD945993D06F" isHorizontal="true"><omgdc:Bounds x="43" y="75" width="1655" height="250" /><bpmndi:BPMNLabel labelStyle="sid-84cb49fd-2f7c-44fb-8950-83c3fa153d3b"><omgdc:Bounds x="47.49999999999999" y="170.42857360839844" width="12.000000000000014" height="59.142852783203125" /></bpmndi:BPMNLabel></bpmndi:BPMNShape><bpmndi:BPMNShape id="sid-57E4FE0D-18E4-478D-BC5D-B15164E93254_gui" bpmnElement="sid-57E4FE0D-18E4-478D-BC5D-B15164E93254" isHorizontal="true"><omgdc:Bounds x="73" y="75" width="1625" height="250" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="sid-D7F237E8-56D0-4283-A3CE-4F0EFE446138_gui" bpmnElement="sid-D7F237E8-56D0-4283-A3CE-4F0EFE446138"><omgdc:Bounds x="150" y="165" width="30" height="30" /><bpmndi:BPMNLabel labelStyle="sid-e0502d32-f8d1-41cf-9c4a-cbb49fecf581"><omgdc:Bounds x="141.8214282989502" y="197" width="46.35714340209961" height="22" /></bpmndi:BPMNLabel></bpmndi:BPMNShape><bpmndi:BPMNShape id="Participant_0zqjpjt_di" bpmnElement="Participant_0zqjpjt"><omgdc:Bounds x="43" y="348" width="1657" height="247" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Participant_0yhypw4_di" bpmnElement="Participant_0yhypw4"><omgdc:Bounds x="43" y="616" width="1651" height="247" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Participant_03wu5er_di" bpmnElement="Participant_03wu5er"><omgdc:Bounds x="43" y="889" width="915" height="250" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_0qhb3aw_di" bpmnElement="Task_0qhb3aw"><omgdc:Bounds x="230" y="140" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNEdge id="SequenceFlow_0rp41cx_di" bpmnElement="SequenceFlow_0rp41cx"><omgdi:waypoint x="180" y="180" /><omgdi:waypoint x="230" y="180" /></bpmndi:BPMNEdge><bpmndi:BPMNShape id="Task_0phvbjb_di" bpmnElement="Task_0phvbjb"><omgdc:Bounds x="380" y="140" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNEdge id="SequenceFlow_1h4dcfb_di" bpmnElement="SequenceFlow_1h4dcfb"><omgdi:waypoint x="330" y="180" /><omgdi:waypoint x="380" y="180" /></bpmndi:BPMNEdge><bpmndi:BPMNShape id="Task_014yg06_di" bpmnElement="Task_014yg06"><omgdc:Bounds x="352" y="431" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNEdge id="MessageFlow_0fcfikb_di" bpmnElement="MessageFlow_0fcfikb"><omgdi:waypoint x="430" y="220" /><omgdi:waypoint x="430" y="431" /></bpmndi:BPMNEdge><bpmndi:BPMNShape id="Task_1kxmblt_di" bpmnElement="Task_1kxmblt"><omgdc:Bounds x="684" y="140" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_00o8ibt_di" bpmnElement="Task_00o8ibt"><omgdc:Bounds x="1150" y="140" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_1gxt8gw_di" bpmnElement="Task_1gxt8gw"><omgdc:Bounds x="1447" y="140" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_0usw65y_di" bpmnElement="Task_0usw65y"><omgdc:Bounds x="684" y="431" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_0lllv5h_di" bpmnElement="Task_0lllv5h"><omgdc:Bounds x="1150" y="415" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_0y3ndud_di" bpmnElement="Task_0y3ndud"><omgdc:Bounds x="1447" y="431" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_01emmgh_di" bpmnElement="Task_01emmgh"><omgdc:Bounds x="339" y="703" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_1pe98do_di" bpmnElement="Task_1pe98do"><omgdc:Bounds x="594" y="703" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_0n7uv02_di" bpmnElement="Task_0n7uv02"><omgdc:Bounds x="801" y="703" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_0z65dbm_di" bpmnElement="Task_0z65dbm"><omgdc:Bounds x="993" y="703" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_1w9eauz_di" bpmnElement="Task_1w9eauz"><omgdc:Bounds x="1150" y="703" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_0is568d_di" bpmnElement="Task_0is568d"><omgdc:Bounds x="1307" y="703" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_17ulza9_di" bpmnElement="Task_17ulza9"><omgdc:Bounds x="1460" y="703" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_113a2yn_di" bpmnElement="Task_113a2yn"><omgdc:Bounds x="334" y="973" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_1w8lulf_di" bpmnElement="Task_1w8lulf"><omgdc:Bounds x="528" y="973" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Task_16la10t_di" bpmnElement="Task_16la10t"><omgdc:Bounds x="697" y="973" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNEdge id="MessageFlow_0oxm7el_di" bpmnElement="MessageFlow_0oxm7el"><omgdi:waypoint x="402" y="511" /><omgdi:waypoint x="402" y="703" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="MessageFlow_1ootxol_di" bpmnElement="MessageFlow_1ootxol"><omgdi:waypoint x="389" y="783" /><omgdi:waypoint x="389" y="973" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0yb93ab_di" bpmnElement="SequenceFlow_0yb93ab"><omgdi:waypoint x="434" y="1013" /><omgdi:waypoint x="528" y="1013" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0um83tc_di" bpmnElement="SequenceFlow_0um83tc"><omgdi:waypoint x="628" y="1013" /><omgdi:waypoint x="697" y="1013" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="MessageFlow_1jzgtp7_di" bpmnElement="MessageFlow_1jzgtp7"><omgdi:waypoint x="747" y="973" /><omgdi:waypoint x="747" y="878" /><omgdi:waypoint x="659" y="878" /><omgdi:waypoint x="659" y="783" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_13w2p5m_di" bpmnElement="SequenceFlow_13w2p5m"><omgdi:waypoint x="694" y="743" /><omgdi:waypoint x="801" y="743" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_14ierwp_di" bpmnElement="SequenceFlow_14ierwp"><omgdi:waypoint x="901" y="743" /><omgdi:waypoint x="993" y="743" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="MessageFlow_0xayg9l_di" bpmnElement="MessageFlow_0xayg9l"><omgdi:waypoint x="1043" y="703" /><omgdi:waypoint x="1043" y="613" /><omgdi:waypoint x="742" y="613" /><omgdi:waypoint x="742" y="511" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="MessageFlow_1ajh8uo_di" bpmnElement="MessageFlow_1ajh8uo"><omgdi:waypoint x="734" y="431" /><omgdi:waypoint x="734" y="220" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_1lkawm0_di" bpmnElement="SequenceFlow_1lkawm0"><omgdi:waypoint x="784" y="180" /><omgdi:waypoint x="1150" y="180" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="MessageFlow_10hbb1y_di" bpmnElement="MessageFlow_10hbb1y"><omgdi:waypoint x="1200" y="220" /><omgdi:waypoint x="1200" y="415" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="MessageFlow_067dnx0_di" bpmnElement="MessageFlow_067dnx0"><omgdi:waypoint x="1200" y="495" /><omgdi:waypoint x="1200" y="703" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0lgxer5_di" bpmnElement="SequenceFlow_0lgxer5"><omgdi:waypoint x="1250" y="743" /><omgdi:waypoint x="1307" y="743" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="SequenceFlow_0owm2dt_di" bpmnElement="SequenceFlow_0owm2dt"><omgdi:waypoint x="1407" y="743" /><omgdi:waypoint x="1460" y="743" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="MessageFlow_0lql24z_di" bpmnElement="MessageFlow_0lql24z"><omgdi:waypoint x="1510" y="703" /><omgdi:waypoint x="1510" y="511" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="MessageFlow_1x3ivxo_di" bpmnElement="MessageFlow_1x3ivxo"><omgdi:waypoint x="1497" y="431" /><omgdi:waypoint x="1497" y="220" /></bpmndi:BPMNEdge><bpmndi:BPMNShape id="EndEvent_0kbyclf_di" bpmnElement="EndEvent_0kbyclf"><omgdc:Bounds x="1609" y="162" width="36" height="36" /></bpmndi:BPMNShape><bpmndi:BPMNEdge id="SequenceFlow_0nudiyd_di" bpmnElement="SequenceFlow_0nudiyd"><omgdi:waypoint x="1547" y="180" /><omgdi:waypoint x="1609" y="180" /></bpmndi:BPMNEdge></bpmndi:BPMNPlane><bpmndi:BPMNLabelStyle id="sid-e0502d32-f8d1-41cf-9c4a-cbb49fecf581"><omgdc:Font name="Arial" size="11" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" /></bpmndi:BPMNLabelStyle><bpmndi:BPMNLabelStyle id="sid-84cb49fd-2f7c-44fb-8950-83c3fa153d3b"><omgdc:Font name="Arial" size="12" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" /></bpmndi:BPMNLabelStyle></bpmndi:BPMNDiagram></definitions>';

		importXML(diagramXML, viewerRef.current);
		setDiagramDefinitions(viewerRef.current);
		viewerRef.current.on("element.changed", handleElementChanged);

		return () => {
			if (viewerRef.current) {
				viewerRef.current.destroy();
			}
		};
	}, []);

	return (
		<div style={{ height: "100%" }}>
			<div id="js-canvas" ref={containerRef} />
			<div id="propview" />
		</div>
	);
};

export default BpmnView;
